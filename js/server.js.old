const express = require('express');
const http = require('http');
const socketIO = require('socket.io');
const cors = require('cors');

const app = express();
const server = http.createServer(app);
const io = socketIO(server);

// Configuración de CORS para Express
app.use(cors({ origin: 'http://127.0.0.1:8080' }));

// Configuración de CORS para Socket.IO
io.use(cors({
    origin: 'http://127.0.0.1:8080',
    methods: ['GET', 'POST'],
    credentials: true
}));

// Servir socket.io.js desde node_modules/socket.io/client-dist
app.use('/socket.io', express.static(__dirname + '/node_modules/socket.io/client-dist'));

// ... Resto de tu código

// Manejar solicitudes OPTIONS (preflight) para CORS
app.options('*', cors());

// Configurar encabezados CORS en Express
app.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', 'http://127.0.0.1:8080');
    res.header('Access-Control-Allow-Methods', 'GET, POST');
    res.header('Access-Control-Allow-Headers', 'Content-Type');
    next();
});

const PORT = process.env.PORT || 3000;

io.use(cors({
    origin: 'http://127.0.0.1:3000',
    methods: ['GET', 'POST'],
    credentials: true
}));


server.listen(PORT, () => {
    console.log(`Servidor escuchando en el puerto ${PORT}`);
});

// Servir archivos estáticos desde el directorio actual
app.use(express.static(__dirname));

// Manejar solicitudes OPTIONS (preflight) para CORS
app.options('*', cors());

// Configurar encabezados CORS en Express
app.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', 'http://127.0.0.1:8080');
    res.header('Access-Control-Allow-Methods', 'GET, POST');
    res.header('Access-Control-Allow-Headers', 'Content-Type');
    next();
});

const lobbies = [];

io.on('connection', (socket) => {
    console.log('Usuario conectado:', socket.id);

    // Unirse a una sala
    socket.on('join', (lobbyCode) => {
        const lobby = lobbies.find((l) => l.code === lobbyCode);

        if (lobby && lobby.players.length < 8) {
            socket.join(lobbyCode);
            lobby.players.push({ id: socket.id, name: `Jugador ${lobby.players.length + 1}` });

            io.to(lobbyCode).emit('updatePlayers', lobby.players);
        } else {
            socket.emit('joinError', 'No se puede unir a la sala');
        }
    });

    // Crear una nueva sala
    socket.on('create', () => {
        const newLobby = { code: generateRandomCode(), players: [] };
        lobbies.push(newLobby);

        socket.join(newLobby.code);
        newLobby.players.push({ id: socket.id, name: `Jugador ${newLobby.players.length + 1}` });

        socket.emit('lobbyCreated', newLobby.code);
        io.to(newLobby.code).emit('updatePlayers', newLobby.players);
    });

    // Manejar la desconexión
    socket.on('disconnect', () => {
        const lobby = lobbies.find((l) => l.players.some((p) => p.id === socket.id));

        if (lobby) {
            lobby.players = lobby.players.filter((p) => p.id !== socket.id);
            io.to(lobby.code).emit('updatePlayers', lobby.players);
        }

        console.log('Usuario desconectado:', socket.id);
    });
});

function generateRandomCode() {
    // Implementa la lógica para generar códigos únicos
    // Puedes usar algoritmos más avanzados dependiendo de tus necesidades
    return Math.random().toString(36).substring(2, 8).toUpperCase();
}
